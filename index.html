<!DOCTYPE html>
<html lang="zh-CN">
<head>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ç®±å‹æŠ¥ä»·">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœ¨ç®±æŠ¥ä»·è®¡ç®—å™¨</title>
<style>
#scrollPad{height:100vh}
* {box-sizing:border-box;margin:0;padding:0}
body{font-family:Segoe UI,Microsoft YaHei,Helvetica,Arial;background:#f5f7fa;padding:15px;color:#333}
.container{max-width:1000px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 6px 25px rgba(0,0,0,.08);overflow:hidden}
.header{background:linear-gradient(135deg,#3498db 0%,#2c3e50 100%);color:#fff;padding:25px;text-align:center}
.header h1{font-size:26px;margin-bottom:6px}
.section{padding:25px}
h3{margin-bottom:15px;font-size:18px}
.btn{padding:9px 18px;border:none;border-radius:6px;font-size:15px;cursor:pointer;transition:.25s}
.btn-primary{background:#3498db;color:#fff}
.btn-primary:hover{background:#2980b9}
.btn-success{background:#2ecc71;color:#fff}
.btn-success:hover{background:#27ae60}
.btn-danger{background:#e74c3c;color:#fff;font-size:13px;padding:6px 12px}
.btn-block{width:100%;margin-top:12px}
.box-item{background:#f8fafc;border:1px solid #e1e8ed;border-radius:8px;padding:12px 15px;margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:center;gap:12px}
.box-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.06)}
.box-item-header{width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.box-item-title{font-weight:600;color:#2c3e50}
.input-group{display:flex;flex-direction:column;min-width:110px;flex:1}
.input-group label{font-size:12px;color:#555;margin-bottom:4px}
.input-group input, .input-group select{padding:7px 9px;border:1px solid #ccd3db;border-radius:4px;font-size:14px}
.input-group input:focus, .input-group select:focus{outline:none;border-color:#3498db}
.unit{font-size:11px;color:#95a5a6;margin-top:3px}
.result-area{background:#ecf0f1;padding:18px;border-radius:8px;margin-top:15px;display:none}
.total-price{font-size:30px;color:#e74c3c;font-weight:700;text-align:center;margin:10px 0}
.history-item{background:#fff;border:1px solid #e1e8ed;border-radius:6px;padding:10px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
#modeToggle{margin-left:15px;font-size:13px;padding:6px 12px}
#proModeHint{display:none;background:#e3f2fd;padding:10px;border-radius:6px;margin-bottom:15px;font-size:13px;color:#1976d2}



.mode-toggle {
  margin: 10px auto 0;    /* é¡¶éƒ¨ç•™ç©ºï¼Œå·¦å³å±…ä¸­ */
  display: flex;
  gap: 5px;
  background: rgba(52,152,219,.2);
  padding: 4px;
  border-radius: 20px;
  width: fit-content;     /* å®½åº¦é€‚åº”å†…å®¹ */
}
.mode-btn{padding:6px 12px;border:none;border-radius:16px;font-size:13px;cursor:pointer;transition:.3s;background:transparent;color:#3498db}
.mode-btn.active{background:#3498db;color:#fff;font-weight:600}
/* æ–°å¢ææ–™é€‰æ‹©å™¨æ ·å¼ */
.materials-row{width:100%;display:flex;gap:12px;margin-top:12px;padding-top:12px;border-top:1px dashed #e1e8ed}
@media(max-width:900px){.materials-row{flex-wrap:wrap}.materials-row .input-group{flex:0 0 calc(50% - 6px)}}
@media(max-width:600px){.materials-row .input-group{flex:0 0 100%}}

@media(max-width:700px){.box-item{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
  <h1>æœ¨ç®±æŠ¥ä»·è®¡ç®—å™¨Pro</h1>
  <p>ç®€æ´æ¨¡å¼ Â· ä¸“ä¸šæ¨¡å¼ Â· æŠ¥ä»·å•</p>
   <div class="mode-toggle">
    <button class="mode-btn active" onclick="switchMode('simple')">ç®€æ´æ¨¡å¼</button>
    <button class="mode-btn" onclick="switchMode('pro')">ä¸“ä¸šæ¨¡å¼</button>
   </div>
   </div>
  <div class="section">
    <h3>å¾…ç®—ç®±å‹åˆ—è¡¨ <span id="modeIndicator" style="color:#3498db;font-size:14px">(ç®€æ´æ¨¡å¼)</span></h3>
    <div id="proModeHint">ä¸“ä¸šæ¨¡å¼ï¼šæ”¯æŒæ¿æ/é¾™éª¨/åº•æ¿/å«è„šå››ç±»ææ–™é€‰æ‹©ï¼Œç²¾ç¡®è®¡ç®—æˆæœ¬æ„æˆ</div>
    <div id="boxList"></div>
    <button class="btn btn-success btn-block" onclick="addBox()">ï¼‹ æ·»åŠ ç®±å‹</button>
    <button class="btn btn-primary btn-block" onclick="calculate()">è®¡ç®—æ€»ä»·</button>
    <div id="resultArea" class="result-area">
      <div class="total-price" id="totalPrice">Â¥0.00</div>
      <div id="resultDetails"></div>
      <button class="btn btn-success" onclick="exportQuotation()">å¯¼å‡ºæŠ¥ä»·å•</button>
    </div>
    <h3 style="margin-top:25px">å†å²æŠ¥ä»·è®°å½•</h3>
    <div id="historyList"></div>
  </div>
</div>

<script>

// æ³¨å†Œ Service Worker å¹¶ç›‘å¬æ›´æ–°
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(reg => {
    console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
    
    // ç›‘å¬ Service Worker æ›´æ–°
    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæ˜¾ç¤ºåˆ·æ–°æç¤º
          showUpdateNotification();
        }
      });
    });
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…ä¸­çš„æ›´æ–°
    if (reg.waiting) {
      showUpdateNotification();
    }
  }).catch(err => console.error('Service Worker æ³¨å†Œå¤±è´¥', err));
}

// æ˜¾ç¤ºæ›´æ–°æç¤º
function showUpdateNotification() {
  const notification = document.createElement('div');
  notification.innerHTML = `
    <div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#3498db;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;display:flex;gap:10px;align-items:center;">
      <span>ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼</span><br>
      <button onclick="location.reload()" style="background:#fff;color:#3498db;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;">ç«‹å³åˆ·æ–°</button>
      <button onclick="this.parentElement.parentElement.remove()" style="background:transparent;color:#fff;border:none;padding:6px;cursor:pointer;">Ã—</button>
    </div>
  `;
  document.body.appendChild(notification);
}
// ææ–™æ•°æ®åº“
const materialDB = {
  board: { '5å˜ç™½æ¿':10.5, '7å˜ç™½æ¿':14.7, '9å˜ç™½æ¿':18.9, '12å˜ç™½æ¿':21.84, '15å˜ç™½æ¿':27.29, '5å˜æ¼‚ç™½æ¿':13.44, '7å˜æ¼‚ç™½æ¿':14.7, '9å˜æ¼‚ç™½æ¿':19.74 },
  keel: { '3.3*1.7*3.5må®æœ¨':1.96, '4.0*2.2*3.6må®æœ¨':3.13, 'åšçª„3.0m':2.29, 'è–„å®½3.0m':2.92, 'åšå®½2.6m':3.85, '4mæ¿æ¡':3.75 },
  bottom: { '12å˜ç™½æ¿':21.84, '15å˜ç™½æ¿':27.29, 'çº¢æ¿':22.64 },
  foot: { 'å®æœ¨':7, 'å¤šå±‚æ¿':8.65, '3.3*1.7*3.5må®æœ¨':1.96, '4.0*2.2*3.6må®æœ¨':3.13, 'åšçª„3.0m':2.29, 'è–„å®½3.0m':2.92, 'åšå®½2.6m':3.85, '4mæ¿æ¡':3.75 }
};

// é»˜è®¤ææ–™é…ç½®
const DEFAULT_MATERIALS = { board:'7å˜ç™½æ¿', keel:'åšçª„3.0m', bottom:'12å˜ç™½æ¿', foot:'å¤šå±‚æ¿' };

let isProMode = false, boxCounter = 0, currentCalc = {};

function switchMode(mode) {
  isProMode = (mode === 'pro');
  document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  const indicator = document.getElementById('modeIndicator');
  indicator.textContent = isProMode ? '(ä¸“ä¸šæ¨¡å¼)' : '(ç®€æ´æ¨¡å¼)';
  
  document.querySelectorAll('.box-item').forEach(card => {
    if (isProMode) upgradeToPro(card); else downgradeToSimple(card);
  });
  
  if (currentCalc.items?.length > 0) setTimeout(() => calculate(), 100);
}

function upgradeToPro(card) {
  // åŒæ—¶è·å–ä»·æ ¼å’Œæ•°é‡å€¼
  const price = card.querySelector('[data-key=price]').value;
  const quantity = card.querySelector('[data-key=q]').value;
  
  // åŒæ—¶åˆ é™¤ä»·æ ¼å’Œæ•°é‡è¾“å…¥æ¡†
  card.querySelector('[data-key=price]').parentElement.remove();
  card.querySelector('[data-key=q]').parentElement.remove();
  
  // é‡æ–°æŒ‰æ­£ç¡®é¡ºåºåˆ›å»ºä»·æ ¼å’Œæ•°é‡è¾“å…¥æ¡†
  const html = `
    <div class="input-group"><label>å•ä»· (å…ƒ/mÂ²)</label><input type="number" min="0.01" step="0.01" data-key="price" value="${price}"></div>
    <div class="input-group"><label>æ•°é‡</label><input type="number" min="1" step="1" data-key="q" value="${quantity}"></div>
    <div class="materials-row">
      <div class="input-group"><label>æ¿æç±»å‹</label><select data-key="boardType" onchange="updateUnitPrice('${card.id}', 'board')"><option value="">é€‰æ‹©æ¿æ</option>${Object.keys(materialDB.board).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="board">-</span></div>
      <div class="input-group"><label>é¾™éª¨ç±»å‹</label><select data-key="keelType" onchange="updateUnitPrice('${card.id}', 'keel')"><option value="">é€‰æ‹©é¾™éª¨</option>${Object.keys(materialDB.keel).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="keel">-</span></div>
      <div class="input-group"><label>åº•æ¿ç±»å‹</label><select data-key="bottomType" onchange="updateUnitPrice('${card.id}', 'bottom')"><option value="">é€‰æ‹©åº•æ¿</option>${Object.keys(materialDB.bottom).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="bottom">-</span></div>
      <div class="input-group"><label>å«è„šç±»å‹</label><select data-key="footType" onchange="updateUnitPrice('${card.id}', 'foot')"><option value="">é€‰æ‹©å«è„š</option>${Object.keys(materialDB.foot).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="foot">-</span></div>
    </div>`;
  
  card.insertAdjacentHTML('beforeend', html);
  
  // è®¾ç½®é»˜è®¤å€¼
  setTimeout(() => {
    ['boardType','keelType','bottomType','footType'].forEach(key => {
      const select = card.querySelector(`[data-key="${key}"]`);
      select.value = DEFAULT_MATERIALS[key.replace('Type','')];
      select.onchange();
    });
  }, 10);
}

function downgradeToSimple(card) {
  // åŒæ—¶è·å–ä»·æ ¼å’Œæ•°é‡çš„å€¼
  const price = card.querySelector('[data-key=price]').value;
  const quantity = card.querySelector('[data-key=q]').value;
  
  // åˆ é™¤ææ–™é€‰æ‹©å™¨è¡Œ
  card.querySelector('.materials-row').remove();
  
  // åŒæ—¶åˆ é™¤ä»·æ ¼å’Œæ•°é‡è¾“å…¥æ¡†
  card.querySelector('[data-key=price]').parentElement.remove();
  card.querySelector('[data-key=q]').parentElement.remove();
  
  // æŒ‰æ­£ç¡®é¡ºåºé‡æ–°åˆ›å»ºä»·æ ¼å’Œæ•°é‡è¾“å…¥æ¡†
  card.insertAdjacentHTML('beforeend', `
    <div class="input-group"><label>å•ä»· (å…ƒ/mÂ²)</label><input type="number" min="0.01" step="0.01" data-key="price" value="${price}"></div>
    <div class="input-group"><label>æ•°é‡</label><input type="number" min="1" step="1" data-key="q" value="${quantity}"></div>
  `);
}

function updateUnitPrice(boxId, materialType) {
  const row = document.getElementById(boxId);
  const select = row.querySelector(`[data-key="${materialType}Type"]`);
  const unitSpan = row.querySelector(`[data-unit="${materialType}"]`);
  const price = materialDB[materialType][select.value] || 0;
  
  const unitText = { board:'Â¥' + price + '/mÂ²', keel:'Â¥' + price + '/m', bottom:'Â¥' + price + '/mÂ²', foot:'Â¥' + price + '/m' };
  unitSpan.textContent = `å•ä»·: ${unitText[materialType]}`;
}

function addBox() {
  boxCounter++;
  const id = `box-${boxCounter}`;
  const div = document.createElement('div');
  div.className = 'box-item';
  div.id = id;
  
  const html = `
    <div class="box-item-header">
      <span class="box-item-title">ç®±å‹ ${boxCounter}</span>
      <button class="btn btn-danger" onclick="delBox('${id}')">åˆ é™¤</button>
    </div>
    <div class="input-group"><label>é•¿ (cm)</label><input type="number" min="0.1" step="0.1" data-key="l"></div>
    <div class="input-group"><label>å®½ (cm)</label><input type="number" min="0.1" step="0.1" data-key="w"></div>
    <div class="input-group"><label>é«˜ (cm)</label><input type="number" min="0.1" step="0.1" data-key="h"></div>
    ${isProMode ? 
      `<div class="input-group"><label>å•ä»· (å…ƒ/mÂ²)</label><input type="number" min="0.01" step="0.01" data-key="price"></div>
       <div class="input-group"><label>æ•°é‡</label><input type="number" min="1" step="1" data-key="q"></div>
       <div class="materials-row">
         <div class="input-group"><label>æ¿æç±»å‹</label><select data-key="boardType" onchange="updateUnitPrice('${id}', 'board')"><option value="">é€‰æ‹©æ¿æ</option>${Object.keys(materialDB.board).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="board">-</span></div>
         <div class="input-group"><label>é¾™éª¨ç±»å‹</label><select data-key="keelType" onchange="updateUnitPrice('${id}', 'keel')"><option value="">é€‰æ‹©é¾™éª¨</option>${Object.keys(materialDB.keel).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="keel">-</span></div>
         <div class="input-group"><label>åº•æ¿ç±»å‹</label><select data-key="bottomType" onchange="updateUnitPrice('${id}', 'bottom')"><option value="">é€‰æ‹©åº•æ¿</option>${Object.keys(materialDB.bottom).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="bottom">-</span></div>
         <div class="input-group"><label>å«è„šç±»å‹</label><select data-key="footType" onchange="updateUnitPrice('${id}', 'foot')"><option value="">é€‰æ‹©å«è„š</option>${Object.keys(materialDB.foot).map(t => `<option value="${t}">${t}</option>`).join('')}</select><span class="unit" data-unit="foot">-</span></div>
       </div>` 
      : `<div class="input-group"><label>å•ä»· (å…ƒ/mÂ²)</label><input type="number" min="0.01" step="0.01" data-key="price"></div>
         <div class="input-group"><label>æ•°é‡</label><input type="number" min="1" step="1" data-key="q"></div>`}`;
  
  div.innerHTML = html;
  document.getElementById('boxList').appendChild(div);
  
  // âœ… ä¿ç•™è¿™ä¸ªåˆå§‹åŒ–ä»£ç ï¼Œä¸è¦åˆ 
  if (isProMode) {
    setTimeout(() => {
      ['boardType','keelType','bottomType','footType'].forEach(key => {
        const select = div.querySelector(`[data-key="${key}"]`);
        select.value = DEFAULT_MATERIALS[key.replace('Type','')];
        select.onchange();
      });
    }, 10);
  }
}

function delBox(id) {
  const card = document.getElementById(id);
  card.style.animation = 'fadeOut .3s';
  setTimeout(() => card.remove(), 300);
}

function calculate() { isProMode ? calculatePro() : calculateSimple(); }

function calculateSimple() {
  const cards = document.querySelectorAll('.box-item');
  if (!cards.length) { alert('è¯·å…ˆæ·»åŠ ç®±å‹'); return; }
  
  currentCalc = { items: [], total: 0, date: new Date().toLocaleString('zh-CN'), mode: 'simple' };
  
  const html = Array.from(cards).map((c, i) => {
    const l = parseFloat(c.querySelector('[data-key=l]').value) || 0;
    const w = parseFloat(c.querySelector('[data-key=w]').value) || 0;
    const h = parseFloat(c.querySelector('[data-key=h]').value) || 0;
    const price = parseFloat(c.querySelector('[data-key=price]').value) || 0;
    const q = parseInt(c.querySelector('[data-key=q]').value) || 0;
    
    if (!(l && w && h && price && q)) { alert(`ç¬¬${i+1}é¡¹æ•°æ®ä¸å®Œæ•´`); return ''; }
    
    const area = 2 * (l* w + l * h + w * h) / 10000;
    const money = area * price * q;
    
    currentCalc.items.push({ size: `${l}Ã—${w}Ã—${h}cm`, q, area: area.toFixed(4), price, money: money.toFixed(2) });
    currentCalc.total += money;
    
    return `<div>ç®±å‹${i+1}  ${l}Ã—${w}Ã—${h}cm Ã—${q}  é¢ç§¯:${area.toFixed(4)}mÂ²  å•ä»·:Â¥${price}  å°è®¡:Â¥${money.toFixed(2)}</div>`;
  }).join('');
  
  if (currentCalc.items.length === 0) return;
  
  document.getElementById('resultDetails').innerHTML = html;
  document.getElementById('totalPrice').textContent = `Â¥${currentCalc.total.toFixed(2)}`;
  document.getElementById('resultArea').style.display = 'block';
  saveHistory(currentCalc);
}

function calculatePro() {
  const cards = document.querySelectorAll('.box-item');
  if (!cards.length) { alert('è¯·å…ˆæ·»åŠ ç®±å‹'); return; }
  
  currentCalc = { items: [], total: { cost: 0, revenue: 0, profit: 0 }, date: new Date().toLocaleString('zh-CN'), mode: 'pro' };
  
  const html = Array.from(cards).map((c, i) => {
    const l = parseFloat(c.querySelector('[data-key=l]').value) || 0;
    const w = parseFloat(c.querySelector('[data-key=w]').value) || 0;
    const h = parseFloat(c.querySelector('[data-key=h]').value) || 0;
    const price = parseFloat(c.querySelector('[data-key=price]').value) || 0;
    const q = parseInt(c.querySelector('[data-key=q]').value) || 0;
    const boardType = c.querySelector('[data-key=boardType]').value;
    const keelType = c.querySelector('[data-key=keelType]').value;
    const bottomType = c.querySelector('[data-key=bottomType]').value;
    const footType = c.querySelector('[data-key=footType]').value;
    
    if (!(l && w && h && q && price && boardType && keelType && bottomType && footType)) {
      alert(`ç¬¬${i+1}é¡¹æ•°æ®ä¸å®Œæ•´`); return '';
    }
    
    // è®¡ç®—æˆæœ¬
    const outL = (l/100) + 0.06;
    const outW = (w/100);
    const outH = (h/100);
    
    const unitCost = 
      materialDB.board[boardType] * (2*outL*outH + 2*outW*outH + outL*(outW+0.06)) +
      materialDB.bottom[bottomType] * outL*(outW+0.06) +
      materialDB.foot[footType] * (2 + Math.round(Math.max(outL, outW)/2.0)) * Math.min(outL, outW) +
      materialDB.keel[keelType] * (4*outL + 4*outW + (8 + Math.round(outL/1.4) + Math.round(outW/1.4)) * outH);
    
    const cost = q * Math.round(unitCost * 100) / 100;
    const area = 2 * (l* w + l * h + w * h) / 10000;
    const revenue = q * price * area;
    const profit = revenue - cost;
    const profitRate = cost > 0 ? (profit / revenue * 100).toFixed(1) : 0;
    
    currentCalc.items.push({
      size: `${l}Ã—${w}Ã—${h}cm`, q, price,
      materials: { boardType, keelType, bottomType, footType },
      cost: cost.toFixed(2), revenue: revenue.toFixed(2), profit: profit.toFixed(2), profitRate
    });
    
    currentCalc.total.cost += cost;
    currentCalc.total.revenue += revenue;
    currentCalc.total.profit += profit;
    
    return `
      <div style="margin-bottom:8px;padding:8px;background:#fff;border-radius:4px;">
        <strong>ç®±å‹${i+1}  ${l}Ã—${w}Ã—${h}cm Ã—${q}</strong><br>
        <span style="color:#e74c3c;">æˆæœ¬: Â¥${cost.toFixed(2)}</span> | 
        <span style="color:#27ae60;">å”®ä»·: Â¥${revenue.toFixed(2)}</span> | 
        <span style="color:#3498db;">åˆ©æ¶¦: Â¥${profit.toFixed(2)}</span> | 
        <span style="color:#9b59b6;">åˆ©æ¶¦ç‡: ${profitRate}%</span>
      </div>`;
  }).join('');
  
  if (currentCalc.items.length === 0) return;
  
  const totalRate = currentCalc.total.cost > 0 ? (currentCalc.total.profit / currentCalc.total.revenue * 100).toFixed(1) : 0;
  
  document.getElementById('resultDetails').innerHTML = html;
document.getElementById('totalPrice').innerHTML = `
  <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
    <div style="font-size:22px;">
      <span style="color:#e74c3c;">æˆæœ¬: Â¥${currentCalc.total.cost.toFixed(2)}</span> | 
      <span style="color:#27ae60;">å”®ä»·: Â¥${currentCalc.total.revenue.toFixed(2)}</span>
    </div>
    <div style="font-size:22px;">
      <span style="color:#3498db;">åˆ©æ¶¦: Â¥${currentCalc.total.profit.toFixed(2)}</span> | 
      <span style="color:#9b59b6;">åˆ©æ¶¦ç‡: ${totalRate}%</span>
    </div>
  </div>`;
  document.getElementById('resultArea').style.display = 'block';
  saveHistory(currentCalc);
}

function saveHistory(data) {
  let h = JSON.parse(localStorage.getItem('boxHistory') || '[]');
  h.unshift(data);
  if (h.length > 50) h = h.slice(0, 50);
  localStorage.setItem('boxHistory', JSON.stringify(h));
  loadHistory();
}

function loadHistory() {
  const h = JSON.parse(localStorage.getItem('boxHistory') || '[]');
  const box = document.getElementById('historyList');
  if (!h.length) {
    box.innerHTML = '<div style="color:#999">æš‚æ— å†å²è®°å½•</div>';
    return;
  }
  
  box.innerHTML = h.map((it, idx) => `
    <div class="history-item">
      <div>
        <div>${it.date}</div>
        <div>å…±${it.items.length}é¡¹  æ€»è®¡:<b>Â¥${(it.total.cost || it.total).toFixed(2)}</b></div>
        <div style="font-size:11px;color:#666">${it.mode === 'pro' ? 'ä¸“ä¸šæ¨¡å¼' : 'ç®€æ˜“æ¨¡å¼'}</div>
      </div>
      <div>
        <button class="btn btn-primary" onclick="loadToCalc(${idx})">è½½å…¥</button>
        <button class="btn btn-danger" onclick="delHistory(${idx})">åˆ é™¤</button>
      </div>
    </div>`).join('');
}

function loadToCalc(idx) {
  const h = JSON.parse(localStorage.getItem('boxHistory') || '[]')[idx];
  if (!h) return;
  
  // æ ¹æ®å†å²è®°å½•æ¨¡å¼åˆ‡æ¢
  if (h.mode === 'pro' && !isProMode) toggleProMode();
  else if (h.mode !== 'pro' && isProMode) toggleProMode();
  
  document.getElementById('boxList').innerHTML = '';
  boxCounter = 0;
  
  // æ¢å¤æ¯ä¸ªå†å²é¡¹
  h.items.forEach((item, index) => {
    addBox();
    const rows = document.querySelectorAll('.box-item');
    const row = rows[rows.length - 1];
    const [l, w, h] = item.size.replace('cm', '').split('Ã—');
    
    // åŸºç¡€æ•°æ®æ¢å¤
    row.querySelector('[data-key=l]').value = l;
    row.querySelector('[data-key=w]').value = w;
    row.querySelector('[data-key=h]').value = h;
    row.querySelector('[data-key=q]').value = item.q;
    row.querySelector('[data-key=price]').value = item.price;
    
    // ä¸“ä¸šæ¨¡å¼ææ–™æ¢å¤ï¼ˆå…³é”®ä¿®å¤ï¼šå¢åŠ å»¶è¿Ÿï¼‰
    if (h.mode === 'pro') {
      setTimeout(() => {
        row.querySelector('[data-key=boardType]').value = item.materials.boardType;
        row.querySelector('[data-key=keelType]').value = item.materials.keelType;
        row.querySelector('[data-key=bottomType]').value = item.materials.bottomType;
        row.querySelector('[data-key=footType]').value = item.materials.footType;
        
        // è§¦å‘ä»·æ ¼æ˜¾ç¤ºæ›´æ–°
        updateUnitPrice(row.id, 'board');
        updateUnitPrice(row.id, 'keel');
        updateUnitPrice(row.id, 'bottom');
        updateUnitPrice(row.id, 'foot');
      }, 50); // 50mså»¶è¿Ÿç¡®ä¿ææ–™é€‰é¡¹æ¸²æŸ“å®Œæˆ
    }
  });
  
  // å»¶è¿Ÿè®¡ç®—ï¼Œç­‰å¾…æ‰€æœ‰ææ–™é€‰æ‹©å™¨åˆå§‹åŒ–
  setTimeout(() => {
    currentCalc = h;
    calculate();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 100);
}

function delHistory(idx) {
  let h = JSON.parse(localStorage.getItem('boxHistory') || '[]');
  h.splice(idx, 1);
  localStorage.setItem('boxHistory', JSON.stringify(h));
  loadHistory();
}

function exportQuotation() {
  if (!currentCalc.items?.length) { alert('æš‚æ— å¯å¯¼å‡ºçš„æ•°æ®'); return; }
  
  const title = `æŠ¥ä»·å•_${new Date().toISOString().slice(0, 10)}`;
  let csv = '\ufeffåºå·,å°ºå¯¸(cm),æ•°é‡,';
  
  if (currentCalc.mode === 'pro') {
    csv += 'å•ä»·(å…ƒ/mÂ²),æ¿æ,é¾™éª¨,åº•æ¿,å«è„š,æˆæœ¬(å…ƒ),å”®ä»·(å…ƒ),åˆ©æ¶¦(å…ƒ),åˆ©æ¶¦ç‡(%)\n';
    currentCalc.items.forEach((it, i) => {
      csv += `${i+1},${it.size},${it.q},${it.price},${it.materials.boardType},${it.materials.keelType},${it.materials.bottomType},${it.materials.footType},${it.cost},${it.revenue},${it.profit},${it.profitRate}\n`;
    });
    csv += `,,,,,,,,æ€»è®¡,${currentCalc.total.cost.toFixed(2)},${currentCalc.total.revenue.toFixed(2)},${currentCalc.total.profit.toFixed(2)}`;
  } else {
    csv += 'é¢ç§¯(mÂ²),å•ä»·(å…ƒ/mÂ²),é‡‘é¢(å…ƒ)\n';
    currentCalc.items.forEach((it, i) => {
      csv += `${i+1},${it.size},${it.q},${it.area},${it.price},${it.money}\n`;
    });
    csv += `,,,,,æ€»è®¡,${currentCalc.total.toFixed(2)}`;
  }
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = title + '.csv';
  link.click();
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
  loadHistory();
  addBox();
});

// é”®ç›˜å¯¼èˆªä¼˜åŒ–
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
    const inputs = Array.from(document.querySelectorAll('input[type="number"]'));
    const idx = inputs.indexOf(e.target);
    if (idx < inputs.length - 1) inputs[idx + 1].focus();
  }
});

function scrollInputToCenter(e) {
  const inp = e.target;
  if (inp.tagName !== 'INPUT' || inp.type !== 'number') return;
  inp.scrollIntoView({ behavior: 'instant', block: 'center' });
  window.scrollBy({ top: 100, behavior: 'instant' });
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    setTimeout(() => window.scrollBy({ top: -60, behavior: 'smooth' }), 350);
  }
}

document.addEventListener('focusin', scrollInputToCenter, true);
</script>
<div id="scrollPad"></div>
</body>
</html>